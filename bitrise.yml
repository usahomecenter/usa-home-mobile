---
format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - BITRISE_PROJECT_PATH: ios/App/App.xcworkspace
  - BITRISE_SCHEME: App
  - BITRISE_EXPORT_METHOD: development

workflows:
  run_tests:
    before_run: []
    after_run: []
    steps:
    - git-clone@8: {}
    - script@1:
        title: Clean Xcode project and build
        inputs:
        - content: |
            #!/usr/bin/env bash
            set -ex
            
            echo "Cleaning Xcode project of problematic file references"
            
            # Navigate to iOS project
            cd ios/App
            
            # Remove references to missing files from project.pbxproj
            if [ -f "App.xcodeproj/project.pbxproj" ]; then
              # Create backup
              cp App.xcodeproj/project.pbxproj App.xcodeproj/project.pbxproj.backup
              
              echo "Removing problematic file references..."
              
              # Remove all references to config.xml
              sed -i '' '/config\.xml/d' App.xcodeproj/project.pbxproj
              
              # Remove all references to capacitor.config.json
              sed -i '' '/capacitor\.config\.json/d' App.xcodeproj/project.pbxproj
              
              # Remove all references to public directory
              sed -i '' '/\/public/d' App.xcodeproj/project.pbxproj
              sed -i '' '/public\//d' App.xcodeproj/project.pbxproj
              
              echo "Removed problematic file references from Xcode project"
              
              # Show difference
              echo "Changes made to project.pbxproj:"
              diff App.xcodeproj/project.pbxproj.backup App.xcodeproj/project.pbxproj || true
            fi
            
            # Create working Podfile
            cat > Podfile << 'EOF'
            platform :ios, '14.0'
            use_frameworks!
            install! 'cocoapods', :disable_input_output_paths => true
            
            target 'App' do
              pod 'Capacitor', '~> 5.0'
              pod 'CapacitorCordova', '~> 5.0'
              pod 'CapacitorApp', '~> 5.0'
              pod 'CapacitorBrowser', '~> 5.0'
              pod 'CapacitorDevice', '~> 5.0'
              pod 'CapacitorNetwork', '~> 5.0'
              pod 'CapacitorPreferences', '~> 5.0'
              pod 'CapacitorSplashScreen', '~> 5.0'
              pod 'CapacitorStatusBar', '~> 5.0'
            end
            
            post_install do |installer|
              installer.pods_project.targets.each do |target|
                target.build_configurations.each do |config|
                  config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
                  config.build_settings['CODE_SIGN_IDENTITY'] = ""
                  config.build_settings['CODE_SIGNING_REQUIRED'] = "NO"
                  config.build_settings['CODE_SIGNING_ALLOWED'] = "NO"
                end
              end
            end
            EOF
            
            echo "Xcode project cleaned and ready for build"
            
    - cocoapods-install@2:
        inputs:
        - source_root_path: ios/App
        
    - xcode-build-for-simulator@0:
        inputs:
        - project_path: ios/App/App.xcworkspace
        - scheme: App
        - destination: platform=iOS Simulator,name=iPhone 14
        - disable_codesign: true
        - xcodebuild_options: CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        
    - deploy-to-bitrise-io@2:
        inputs:
        - notify_user_groups: none
        - is_enable_public_page: false
