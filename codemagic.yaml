workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      vars:
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
        BUNDLE_ID: "center.usahome.app"
      node: v18
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install dependencies
        script: |
          npm ci
      - name: Install CocoaPods
        script: |
          cd ios/App
          pod install --repo-update
      - name: Create web content
        script: |
          mkdir -p client/dist
          cat > client/dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
            <title>USA Home</title>
            <style>
              body { 
                margin: 0; 
                padding: 20px; 
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                background: linear-gradient(135deg, #1e3a8a, #3b82f6);
                color: white;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
              }
              .app { 
                text-align: center;
                padding: 40px;
                background: rgba(255,255,255,0.1);
                border-radius: 20px;
                backdrop-filter: blur(10px);
              }
              h1 { font-size: 2.5rem; margin-bottom: 20px; }
              p { font-size: 1.2rem; margin: 10px 0; opacity: 0.9; }
            </style>
          </head>
          <body>
            <div class="app">
              <h1>USA Home</h1>
              <p>Home Building & Design Platform</p>
              <p>Version 1.0</p>
            </div>
          </body>
          </html>
          EOF
          
          mkdir -p ios/App/App/public
          cp -r client/dist/* ios/App/App/public/
          ls -la ios/App/App/public/
      - name: Update iOS settings
        script: |
          cd ios/App/App
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier center.usahome.app" Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName USA Home" Info.plist
      - name: Set up keychain
        script: |
          keychain initialize
      - name: Build iOS app
        script: |
          cd ios/App
          xcodebuild -workspace App.xcworkspace \
                     -scheme App \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath App.xcarchive \
                     archive
          
          xcodebuild -exportArchive \
                     -archivePath App.xcarchive \
                     -exportPath ../.. \
                     -exportOptionsPlist ../exportOptions.plist
    artifacts:
      - "*.ipa"
      - /tmp/xcodebuild_logs/*.log
